<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AMOS â Voice Line</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--surface:#111118;--surface2:#1a1a24;--border:#2a2a3a;--accent:#6c5ce7;--accent-glow:rgba(108,92,231,.3);--text:#e8e8f0;--text2:#8888a0;--user-bg:#6c5ce7;--bot-bg:#1e1e2e;--danger:#ff4757;--success:#2ed573}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}

/* Header */
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;z-index:10;flex-shrink:0}
.header-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),#a29bfe);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff;letter-spacing:-1px}
.header-info h1{font-size:16px;font-weight:700;letter-spacing:.5px}
.header-info p{font-size:11px;color:var(--text2);margin-top:1px}
.status-dot{width:7px;height:7px;background:var(--success);border-radius:50%;display:inline-block;margin-right:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.header-actions{margin-left:auto;display:flex;gap:8px}
.header-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text2);width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s}
.header-btn:hover,.header-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* Chat Area */
.chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
.msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.5;word-wrap:break-word;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.user{align-self:flex-end;background:var(--user-bg);color:#fff;border-bottom-right-radius:4px}
.msg.bot{align-self:flex-start;background:var(--bot-bg);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.bot .sender{font-size:11px;color:var(--accent);font-weight:600;margin-bottom:4px;letter-spacing:.5px}
.msg.system{align-self:center;background:transparent;color:var(--text2);font-size:12px;font-style:italic;padding:4px 8px}
.typing{align-self:flex-start;background:var(--bot-bg);border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;padding:12px 18px;display:none}
.typing span{display:inline-block;width:8px;height:8px;background:var(--text2);border-radius:50%;margin:0 2px;animation:bounce .6s infinite}
.typing span:nth-child(2){animation-delay:.15s}
.typing span:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

/* Input Area */
.input-area{background:var(--surface);border-top:1px solid var(--border);padding:10px 12px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0}
.input-wrap{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:20px;display:flex;align-items:flex-end;padding:4px 4px 4px 16px;transition:border-color .2s}
.input-wrap:focus-within{border-color:var(--accent)}
#msgInput{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;resize:none;outline:none;max-height:120px;line-height:1.4;padding:6px 0;font-family:inherit}
#msgInput::placeholder{color:var(--text2)}
.btn{width:38px;height:38px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;flex-shrink:0}
.btn-send{background:var(--accent);color:#fff;font-size:18px}
.btn-send:disabled{opacity:.3;cursor:default}
.btn-send:not(:disabled):hover{background:#7c6cf7;transform:scale(1.05)}
.btn-mic{background:var(--surface2);border:1px solid var(--border);color:var(--text2);font-size:18px}
.btn-mic:hover{border-color:var(--accent);color:var(--accent)}
.btn-mic.recording{background:var(--danger);border-color:var(--danger);color:#fff;animation:mic-pulse 1s infinite}
@keyframes mic-pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,71,87,.4)}50%{box-shadow:0 0 0 10px rgba(255,71,87,0)}}

/* Markdown in bot msgs */
.msg.bot code{background:rgba(108,92,231,.2);padding:1px 5px;border-radius:4px;font-size:13px;font-family:'Courier New',monospace}
.msg.bot pre{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;margin:6px 0;overflow-x:auto}
.msg.bot pre code{background:transparent;padding:0}
.msg.bot strong{color:#a29bfe}
.msg.bot ul,.msg.bot ol{margin:6px 0 6px 18px}
.msg.bot li{margin:2px 0}
.msg.bot p{margin:4px 0}
.msg.bot p:first-child{margin-top:0}
.msg.bot p:last-child{margin-bottom:0}
</style>
</head>
<body>

<div class="header">
  <div class="header-icon">A</div>
  <div class="header-info">
    <h1>AMOS</h1>
    <p><span class="status-dot"></span>TCC Operations Core</p>
  </div>
  <div class="header-actions">
    <button class="header-btn" id="speakerToggle" title="Toggle TTS">&#128264;</button>
    <button class="header-btn" id="clearBtn" title="Clear chat">&#128465;</button>
  </div>
</div>

<div class="chat" id="chat">
  <div class="msg bot">
    <div class="sender">AMOS</div>
    <div>Online and operational, General. What do you need?</div>
  </div>
</div>
<div class="typing" id="typing"><span></span><span></span><span></span></div>

<div class="input-area">
  <button class="btn btn-mic" id="micBtn" title="Voice input">&#127908;</button>
  <div class="input-wrap">
    <textarea id="msgInput" rows="1" placeholder="Message AMOS..." autocomplete="off"></textarea>
  </div>
  <button class="btn btn-send" id="sendBtn" disabled title="Send">&#10148;</button>
</div>

<script>
const chat = document.getElementById('chat');
const input = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const typing = document.getElementById('typing');
const speakerToggle = document.getElementById('speakerToggle');
const clearBtn = document.getElementById('clearBtn');

let ttsEnabled = true;
let isRecording = false;
let recognition = null;
let history = [];
const AUTH = 'amos-bridge-2026';

// Auto-detect base URL (works via tunnel or localhost)
const BASE = location.origin;

// TTS toggle
speakerToggle.classList.add('active');
speakerToggle.addEventListener('click', () => {
  ttsEnabled = !ttsEnabled;
  speakerToggle.classList.toggle('active', ttsEnabled);
  speakerToggle.innerHTML = ttsEnabled ? '&#128264;' : '&#128263;';
});

// Clear chat
clearBtn.addEventListener('click', () => {
  history = [];
  chat.innerHTML = '';
  addMsg('bot', 'Chat cleared. Ready when you are, General.');
});

// Auto-resize textarea
input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  sendBtn.disabled = !input.value.trim();
});

// Enter to send (shift+enter for newline)
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    if (input.value.trim()) send();
  }
});

sendBtn.addEventListener('click', send);

// Simple markdown renderer
function renderMd(text) {
  let html = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^### (.+)$/gm, '<strong style="font-size:15px">$1</strong>')
    .replace(/^## (.+)$/gm, '<strong style="font-size:16px">$1</strong>')
    .replace(/^# (.+)$/gm, '<strong style="font-size:17px">$1</strong>')
    .replace(/^[-*] (.+)$/gm, '&bull; $1');
  // Paragraphs
  html = html.split('\n\n').map(p => {
    p = p.trim();
    if (!p) return '';
    if (p.startsWith('<pre>') || p.startsWith('<strong style')) return p;
    return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
  }).join('');
  return html;
}

function stripHtml(str) {
  // Remove any HTML tags from AI responses
  return str.replace(/<[^>]*>/g, '');
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (role === 'bot') {
    const clean = stripHtml(text);
    div.innerHTML = '<div class="sender">AMOS</div><div>' + renderMd(clean) + '</div>';
  } else {
    div.textContent = text;
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

async function send() {
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  input.style.height = 'auto';
  sendBtn.disabled = true;

  addMsg('user', text);
  history.push({role: 'user', content: text});

  typing.style.display = 'block';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;

  try {
    const res = await fetch(BASE + '/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-Auth': AUTH},
      body: JSON.stringify({message: text, history: history.slice(-20)})
    });
    const data = await res.json();
    typing.style.display = 'none';

    if (data.reply) {
      addMsg('bot', data.reply);
      history.push({role: 'assistant', content: data.reply});
      if (ttsEnabled) speakText(data.reply);
    } else {
      addMsg('bot', 'Error: ' + (data.error || 'No response'));
    }
  } catch (err) {
    typing.style.display = 'none';
    addMsg('bot', 'Connection error: ' + err.message);
  }
}

async function speakText(text) {
  // Strip markdown for TTS
  const clean = text.replace(/[*#`]/g, '').replace(/\n+/g, '. ').substring(0, 500);
  try {
    await fetch(BASE + '/speak', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-Auth': AUTH},
      body: JSON.stringify({text: clean})
    });
  } catch(e) {
    // Fallback to browser TTS
    if ('speechSynthesis' in window) {
      const u = new SpeechSynthesisUtterance(clean);
      u.rate = 1.1;
      speechSynthesis.speak(u);
    }
  }
}

// Voice input via Web Speech API
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onresult = (e) => {
    let final = '', interim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    input.value = final || interim;
    input.dispatchEvent(new Event('input'));
  };

  recognition.onend = () => {
    isRecording = false;
    micBtn.classList.remove('recording');
    if (input.value.trim()) {
      setTimeout(send, 300);
    }
  };

  recognition.onerror = (e) => {
    isRecording = false;
    micBtn.classList.remove('recording');
    if (e.error !== 'no-speech') {
      addMsg('bot', 'Mic error: ' + e.error + '. Check browser permissions.');
    }
  };

  micBtn.addEventListener('click', () => {
    if (isRecording) {
      recognition.stop();
    } else {
      isRecording = true;
      micBtn.classList.add('recording');
      input.value = '';
      recognition.start();
    }
  });
} else {
  micBtn.style.display = 'none';
}

// Focus input on load
input.focus();
</script>
</body>
</html>