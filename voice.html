<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Zero â The Cosmic Claws</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --border: #1e1e2e;
  --text: #e0e0e8;
  --muted: #6b6b80;
  --accent: #7c3aed;
  --accent-glow: rgba(124, 58, 237, 0.3);
  --user-bg: #1a1a2e;
  --ai-bg: #0f0f1a;
  --danger: #ef4444;
}
html, body { 
  height: 100%; 
  background: var(--bg); 
  color: var(--text); 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  overflow: hidden;
}
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh;
  max-width: 600px;
  margin: 0 auto;
}

/* Header */
.header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  text-align: center;
  flex-shrink: 0;
  background: linear-gradient(180deg, #0f0f1a 0%, var(--bg) 100%);
}
.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  background: linear-gradient(135deg, #7c3aed, #a78bfa, #c4b5fd);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header .subtitle {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
  letter-spacing: 1px;
}
.status-dot {
  display: inline-block;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #22c55e;
  margin-right: 6px;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Messages */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px 12px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}
.msg {
  display: flex;
  margin-bottom: 12px;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.msg.user { justify-content: flex-end; }
.msg.ai { justify-content: flex-start; }
.msg-bubble {
  max-width: 82%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  line-height: 1.5;
  word-wrap: break-word;
}
.msg.user .msg-bubble {
  background: var(--accent);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.msg.ai .msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}
.msg-label {
  font-size: 10px;
  color: var(--muted);
  margin-bottom: 3px;
  letter-spacing: 0.5px;
}
.msg.ai .msg-label { text-align: left; }
.msg.user .msg-label { text-align: right; }
.typing-indicator {
  display: flex;
  gap: 4px;
  padding: 8px 14px;
}
.typing-indicator span {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--muted);
  animation: typing 1.4s infinite;
}
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* Input area */
.input-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  flex-shrink: 0;
}
.input-row {
  display: flex;
  gap: 8px;
  align-items: flex-end;
}
#msgInput {
  flex: 1;
  padding: 12px 16px;
  border-radius: 24px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 16px;
  outline: none;
  resize: none;
  max-height: 100px;
  font-family: inherit;
  line-height: 1.4;
}
#msgInput:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}
#msgInput::placeholder { color: var(--muted); }
.btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.2s;
}
.btn-send {
  background: var(--accent);
  color: #fff;
}
.btn-send:active { transform: scale(0.92); }
.btn-send:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-mic {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-mic.recording {
  background: var(--danger);
  border-color: var(--danger);
  color: #fff;
  animation: micPulse 1s infinite;
}
@keyframes micPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
}
.btn-speak {
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 12px;
}
.btn-speak.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

/* SVG icons */
svg { width: 20px; height: 20px; fill: currentColor; }
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <h1><span class="status-dot"></span> ZERO</h1>
    <div class="subtitle">THE COSMIC CLAWS VOICE LINE</div>
  </div>
  
  <div class="messages" id="messages">
    <div class="msg ai">
      <div>
        <div class="msg-label">ZERO</div>
        <div class="msg-bubble">The Cosmic Claw is online. What's on your mind?</div>
      </div>
    </div>
  </div>
  
  <div class="input-area">
    <div class="input-row">
      <button class="btn btn-mic" id="micBtn" title="Voice input">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
      </button>
      <textarea id="msgInput" placeholder="Talk to Zero..." rows="1"></textarea>
      <button class="btn btn-send" id="sendBtn" title="Send">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
      <button class="btn btn-speak" id="speakToggle" title="Toggle voice replies">
        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.origin;
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const speakToggle = document.getElementById('speakToggle');

let history = [];
let isProcessing = false;
let speakReplies = true;
let recognition = null;

// Auto-resize textarea
inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 100) + 'px';
});

// Send on Enter (shift+enter for newline)
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

sendBtn.addEventListener('click', sendMessage);

// Toggle speak
speakToggle.classList.add('active');
speakToggle.addEventListener('click', () => {
  speakReplies = !speakReplies;
  speakToggle.classList.toggle('active', speakReplies);
});

// Speech recognition (Web Speech API)
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  
  let isRecording = false;
  
  micBtn.addEventListener('click', () => {
    if (isRecording) {
      recognition.stop();
      return;
    }
    isRecording = true;
    micBtn.classList.add('recording');
    inputEl.placeholder = 'Listening...';
    recognition.start();
  });
  
  recognition.onresult = (event) => {
    let transcript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    inputEl.value = transcript;
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 100) + 'px';
    
    // Auto-send on final result
    if (event.results[event.results.length - 1].isFinal) {
      setTimeout(() => sendMessage(), 200);
    }
  };
  
  recognition.onend = () => {
    isRecording = false;
    micBtn.classList.remove('recording');
    inputEl.placeholder = 'Talk to Zero...';
  };
  
  recognition.onerror = (e) => {
    isRecording = false;
    micBtn.classList.remove('recording');
    inputEl.placeholder = 'Talk to Zero...';
    if (e.error !== 'no-speech' && e.error !== 'aborted') {
      addMessage('ai', 'Mic error: ' + e.error + '. Try typing instead.');
    }
  };
} else {
  micBtn.style.display = 'none';
}

function addMessage(role, text) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'msg ' + role;
  const label = role === 'ai' ? 'ZERO' : 'YOU';
  msgDiv.innerHTML = '<div><div class="msg-label">' + label + '</div><div class="msg-bubble">' + escapeHtml(text) + '</div></div>';
  messagesEl.appendChild(msgDiv);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return msgDiv;
}

function showTyping() {
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'typing';
  div.innerHTML = '<div><div class="msg-label">ZERO</div><div class="msg-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>';
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function hideTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text || isProcessing) return;
  
  isProcessing = true;
  sendBtn.disabled = true;
  inputEl.value = '';
  inputEl.style.height = 'auto';
  
  addMessage('user', text);
  history.push({ role: 'user', content: text });
  
  showTyping();
  
  try {
    const resp = await fetch(API_BASE + '/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        history: history.slice(-18)
      })
    });
    
    hideTyping();
    
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: 'Unknown error' }));
      addMessage('ai', 'Error: ' + (err.error || resp.statusText));
      return;
    }
    
    const data = await resp.json();
    const reply = data.reply || 'No response.';
    
    addMessage('ai', reply);
    history.push({ role: 'assistant', content: reply });
    
    // Speak the reply
    if (speakReplies) {
      speakText(reply);
    }
    
  } catch (e) {
    hideTyping();
    addMessage('ai', 'Connection error. Is the bridge running?');
  } finally {
    isProcessing = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }
}

function speakText(text) {
  // Use browser TTS as primary (works without auth)
  if ('speechSynthesis' in window) {
    const utter = new SpeechSynthesization(text);
    utter.rate = 1.0;
    utter.pitch = 0.9;
    window.speechSynthesis.speak(utter);
  }
}

// Fix: should be SpeechSynthesisUtterance
function speakText(text) {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.05;
    utter.pitch = 0.85;
    // Try to pick a good voice
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v => v.name.includes('Google') && v.lang.startsWith('en')) 
                   || voices.find(v => v.lang.startsWith('en'));
    if (preferred) utter.voice = preferred;
    window.speechSynthesis.speak(utter);
  }
}

// Load voices
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}

// Focus input on load
window.addEventListener('load', () => inputEl.focus());
</script>
</body>
</html>