<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="theme-color" content="#0a0a0a"><title>Echo Voice AI</title><style>*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#0a0a0a;color:#e0e0e0;min-height:100vh;padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) calc(env(safe-area-inset-bottom,0) + 16px) env(safe-area-inset-left,0);overscroll-behavior:none;-webkit-tap-highlight-color:transparent;touch-action:manipulation;user-select:none;-webkit-user-select:none}button,input,select{touch-action:manipulation;-webkit-tap-highlight-color:transparent}button:active{transform:scale(0.97)}#app{max-width:600px;margin:0 auto;padding:20px 16px}header{text-align:center;margin-bottom:24px}h1{font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:-0.5px}#subtitle{font-size:14px;color:#888;display:flex;align-items:center;justify-content:center;gap:8px}#tts-status-dot{width:8px;height:8px;border-radius:50%;background:#666;transition:background 0.3s}#tts-status-dot.ready{background:#22c55e}#tts-status-dot.working{background:#eab308}#tts-status-dot.error{background:#ef4444}#zero-dot{width:10px;height:10px;border-radius:50%;background:#22c55e;animation:pulse 2s ease-in-out infinite;margin-left:4px;display:none}#zero-dot.active{display:inline-block}@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.2)}}#api-key-section{background:#151515;border:1px solid #2a2a2a;border-radius:12px;padding:16px;margin-bottom:20px}#api-key-section.has-key{padding:12px}#api-key-input{width:100%;padding:12px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;color:#e0e0e0;font-size:14px;margin-bottom:12px}#api-key-input::placeholder{color:#555}#api-key-input:focus{outline:none;border-color:#3b82f6}.button-group{display:flex;gap:8px}button{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;flex:1}button:disabled{opacity:0.5;cursor:not-allowed}#save-key-btn{background:#3b82f6;color:#fff}#save-key-btn:hover:not(:disabled){background:#2563eb}#clear-key-btn{background:#dc2626;color:#fff}#clear-key-btn:hover:not(:disabled){background:#b91c1c}#key-saved-banner{background:#166534;border:1px solid #22c55e;border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center}#key-saved-banner p{font-size:14px;color:#86efac;margin:0}#change-key-btn{background:#15803d;color:#fff;padding:8px 16px;font-size:13px}#change-key-btn:hover{background:#166534}#controls{text-align:center;margin-bottom:24px}#mic-btn{width:120px;height:120px;border-radius:50%;border:none;font-size:48px;cursor:pointer;margin:0 auto 16px;display:block;position:relative;transition:all 0.3s;box-shadow:0 4px 20px rgba(0,0,0,0.3)}#mic-btn.ready{background:linear-gradient(135deg,#3b82f6,#2563eb)}#mic-btn.listening{background:linear-gradient(135deg,#22c55e,#16a34a);animation:ripple 1.5s ease-out infinite}#mic-btn.thinking{background:linear-gradient(135deg,#eab308,#ca8a04);animation:spin 1s linear infinite}#mic-btn.speaking{background:linear-gradient(135deg,#8b5cf6,#7c3aed)}#mic-btn:disabled{opacity:0.6;cursor:not-allowed}@keyframes ripple{0%{box-shadow:0 0 0 0 rgba(34,197,94,0.7)}100%{box-shadow:0 0 0 40px rgba(34,197,94,0)}}@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}#stop-btn{background:#dc2626;color:#fff;padding:12px 32px;font-size:16px;display:none;margin:16px auto 16px}#stop-btn:hover:not(:disabled){background:#b91c1c}#options{display:flex;flex-direction:column;gap:12px;margin-bottom:24px;padding:0 8px}#options label{display:flex;align-items:center;gap:8px;font-size:14px;color:#a0a0a0;cursor:pointer}#options input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:#3b82f6}#tts-mode-group{display:flex;align-items:center;gap:12px;flex-wrap:wrap}#tts-mode{background:#151515;border:1px solid #2a2a2a;border-radius:8px;color:#e0e0e0;padding:8px 12px;font-size:14px;cursor:pointer;flex:1;min-width:120px}#tts-mode:focus{outline:none;border-color:#3b82f6}#chat-log{background:#151515;border:1px solid #2a2a2a;border-radius:12px;padding:16px;margin-bottom:20px;max-height:400px;overflow-y:auto;font-size:14px;line-height:1.6}#chat-log::-webkit-scrollbar{width:8px}#chat-log::-webkit-scrollbar-track{background:#0a0a0a;border-radius:4px}#chat-log::-webkit-scrollbar-thumb{background:#2a2a2a;border-radius:4px}#chat-log::-webkit-scrollbar-thumb:hover{background:#3a3a3a}.message{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #1a1a1a}.message:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}.message-role{font-weight:700;margin-bottom:6px;font-size:12px;text-transform:uppercase;letter-spacing:0.5px}.message-role.user{color:#3b82f6}.message-role.assistant{color:#22c55e}.message-content{color:#d0d0d0;white-space:pre-wrap;word-wrap:break-word}#debug-section{margin-bottom:20px}#debug-toggle{background:#151515;border:1px solid #2a2a2a;color:#888;padding:10px 16px;width:100%;text-align:left;border-radius:8px;cursor:pointer;font-size:14px;display:flex;justify-content:space-between;align-items:center}#debug-toggle:hover{background:#1a1a1a}#debug-log{background:#0a0a0a;border:1px solid #2a2a2a;border-radius:0 0 8px 8px;border-top:none;padding:16px;max-height:300px;overflow-y:auto;font-family:'Courier New',monospace;font-size:12px;line-height:1.5;display:none}#debug-log::-webkit-scrollbar{width:8px}#debug-log::-webkit-scrollbar-track{background:#000;border-radius:4px}#debug-log::-webkit-scrollbar-thumb{background:#2a2a2a;border-radius:4px}.debug-entry{margin-bottom:8px;color:#888}.debug-entry.info{color:#3b82f6}.debug-entry.success{color:#22c55e}.debug-entry.error{color:#ef4444}.debug-entry.warn{color:#eab308}footer{text-align:center;font-size:12px;color:#555;padding-top:20px;border-top:1px solid #1a1a1a}@media(max-width:400px){h1{font-size:24px}#mic-btn{width:100px;height:100px;font-size:40px}button{font-size:13px;padding:9px 16px}}</style>
</head>
<body>
<div id="header">
<h1 id="title">Voice AI</h1>
<div id="subtitle">OpenAI Realtime + TTS + Samsung Chrome</div>
<div id="statusDots">
<div id="ttsDot" class="dot" title="TTS Status"></div>
<div id="zeroDot" class="dot" title="Zero Connection"></div>
</div>
</div>
<div id="keySection">
<input type="password" id="keyInput" placeholder="Enter OpenAI API Key" autocomplete="off" />
<button onclick="saveKey()">Save Key</button>
<button onclick="clearKey()">Clear Key</button>
</div>
<div id="keySaved" style="display:none;">
<div style="color:#4a9eff;margin-bottom:10px;">â API Key Saved</div>
<button onclick="changeKey()">Change Key</button>
</div>
<div style="margin:15px 0;">
<label for="ttsMode" style="margin-right:8px;color:#ddd;">TTS Mode:</label>
<select id="ttsMode">
<option value="auto">Auto (CloudâLocal)</option>
<option value="cloud">Cloud Only</option>
<option value="local">Local Only</option>
</select>
</div>
<div id="micBtn" onclick="micTap()">ð¤</div>
<div id="stopBtn" onclick="stopAll()" style="display:none;">â¹</div>
<div style="margin:15px 0;">
<label style="color:#ddd;cursor:pointer;user-select:none;">
<input type="checkbox" id="autoListen" checked /> Auto-listen after AI response
</label>
</div>
<div id="chatLog"></div>
<div id="debugLog"></div>
<button id="debugToggle" onclick="toggleDebug()">Show Debug</button>
<div id="footer">v5 â war room final</div>
<script>
'use strict';const STATE={IDLE:'idle',LISTENING:'listening',THINKING:'thinking',SPEAKING:'speaking'};const MAX_MESSAGES=20;const MAX_LOG_ENTRIES=200;const FETCH_TIMEOUT=30000;const RECOGNITION_RESTART_DELAY=200;const AUTO_LISTEN_DELAY=300;const TTS_RACE_HEADSTART=500;let currentState=STATE.IDLE;let apiKey='';let autoListen=false;let ttsMode='auto';let conversationHistory=[];let recognition=null;let isRecognitionActive=false;let currentAudioURL=null;let wakeLock=null;let abortController=null;let pendingSpeech=null;let audioUnlocked=false;let logEntries=[];const urlParams=new URLSearchParams(window.location.search);const isZeroMode=urlParams.get('key')==='tcc-general-2026';const elements={keySection:document.getElementById('keySection'),keyInput:document.getElementById('keyInput'),saveKeyBtn:document.getElementById('saveKeyBtn'),keyStatus:document.getElementById('keyStatus'),settingsBtn:document.getElementById('settingsBtn'),settingsPanel:document.getElementById('settingsPanel'),autoListenToggle:document.getElementById('autoListenToggle'),chatContainer:document.getElementById('chatContainer'),micBtn:document.getElementById('micBtn'),stopBtn:document.getElementById('stopBtn'),statusText:document.getElementById('statusText'),audioPlayer:document.getElementById('audioPlayer'),debugToggle:document.getElementById('debugToggle'),debugLog:document.getElementById('debugLog'),titleText:document.getElementById('titleText'),pulseDot:document.getElementById('pulseDot')};function log(message,level='info'){const timestamp=new Date().toISOString().substr(11,12);const entry={time:timestamp,level,message};logEntries.push(entry);if(logEntries.length>MAX_LOG_ENTRIES){logEntries.shift();}const logDiv=document.createElement('div');logDiv.className='log-entry';logDiv.innerHTML=`<span class="time">${timestamp}</span> <span class="level-${level}">[${level.toUpperCase()}]</span> ${message}`;elements.debugLog.appendChild(logDiv);elements.debugLog.scrollTop=elements.debugLog.scrollHeight;console.log(`[${timestamp}] [${level.toUpperCase()}] ${message}`);}function safeLocalStorageGet(key,defaultValue=''){try{const value=localStorage.getItem(key);return value!==null?value:defaultValue;}catch(e){log(`localStorage get error for ${key}: ${e.message}`,'error');return defaultValue;}}function safeLocalStorageSet(key,value){try{localStorage.setItem(key,value);return true;}catch(e){log(`localStorage set error for ${key}: ${e.message}`,'error');return false;}}function safeLocalStorageRemove(key){try{localStorage.removeItem(key);return true;}catch(e){log(`localStorage remove error for ${key}: ${e.message}`,'error');return false;}}function setState(newState){const validTransitions={[STATE.IDLE]:[STATE.LISTENING],[STATE.LISTENING]:[STATE.THINKING,STATE.IDLE],[STATE.THINKING]:[STATE.SPEAKING,STATE.IDLE],[STATE.SPEAKING]:[STATE.IDLE,STATE.LISTENING]};const allowed=validTransitions[currentState];if(!allowed||!allowed.includes(newState)){log(`Invalid state transition: ${currentState} -> ${newState}`,'warn');return false;}log(`State transition: ${currentState} -> ${newState}`);currentState=newState;updateUI();return true;}function updateUI(){elements.micBtn.className='';elements.stopBtn.style.display='none';elements.statusText.textContent='';switch(currentState){case STATE.IDLE:elements.micBtn.textContent='ð¤';elements.micBtn.disabled=false;elements.statusText.textContent='Tap to speak';break;case STATE.LISTENING:elements.micBtn.textContent='ð¤';elements.micBtn.classList.add('listening');elements.micBtn.disabled=false;elements.stopBtn.style.display='block';elements.statusText.textContent='Listening...';break;case STATE.THINKING:elements.micBtn.textContent='â³';elements.micBtn.classList.add('thinking');elements.micBtn.disabled=true;elements.stopBtn.style.display='block';elements.statusText.textContent='Thinking...';break;case STATE.SPEAKING:elements.micBtn.textContent='ð';elements.micBtn.classList.add('speaking');elements.micBtn.disabled=false;elements.stopBtn.style.display='block';elements.statusText.textContent='Speaking...';break;}}function addMessage(role,content){conversationHistory.push({role,content});if(conversationHistory.length>MAX_MESSAGES){conversationHistory.splice(1,2);}const messageDiv=document.createElement('div');messageDiv.className=`message ${role}`;const avatar=document.createElement('div');avatar.className='avatar';avatar.textContent=role==='user'?'ð¤':role==='assistant'?'ð¤':'â¹ï¸';const bubble=document.createElement('div');bubble.className='bubble';bubble.textContent=content;messageDiv.appendChild(avatar);messageDiv.appendChild(bubble);elements.chatContainer.appendChild(messageDiv);elements.chatContainer.scrollTop=elements.chatContainer.scrollHeight;}async function unlockAudio(){if(audioUnlocked)return;try{const silentMP3='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD////////////////////////////////////////////////////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABMYXZmNTguNzYuMTAwAAAAAAAAAAAAAAAkAAAAAAAAA4T3RjL3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/7UGQAD/AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+1BkRg/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';elements.audioPlayer.src=silentMP3;await elements.audioPlayer.play();audioUnlocked=true;log('Audio unlocked');}catch(e){log(`Audio unlock failed: ${e.message}`,'warn');}}async function requestWakeLock(){if(!('wakeLock'in navigator))return;try{wakeLock=await navigator.wakeLock.request('screen');log('Wake lock acquired');wakeLock.addEventListener('release',()=>{log('Wake lock released');});}catch(e){log(`Wake lock error: ${e.message}`,'warn');}}function releaseWakeLock(){if(wakeLock){wakeLock.release();wakeLock=null;}}function initRecognition(){const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SpeechRecognition){log('Speech recognition not supported','error');addMessage('system','Speech recognition is not supported in this browser.');return null;}recognition=new SpeechRecognition();recognition.continuous=false;recognition.interimResults=false;recognition.lang='en-US';recognition.onstart=()=>{log('Recognition started');isRecognitionActive=true;};recognition.onresult=(event)=>{log('Recognition result received');const transcript=event.results[0][0].transcript;log(`Transcript: ${transcript}`);addMessage('user',transcript);handleUserMessage(transcript);};recognition.onerror=(event)=>{log(`Recognition error: ${event.error}`,'error');isRecognitionActive=false;switch(event.error){case'no-speech':if(autoListen&&currentState===STATE.LISTENING){setTimeout(startListening,RECOGNITION_RESTART_DELAY);}else{setState(STATE.IDLE);}break;case'not-allowed':addMessage('system','Microphone permission denied. Please allow microphone access.');setState(STATE.IDLE);break;case'aborted':log('Recognition aborted (expected during stop)');setState(STATE.IDLE);break;case'network':addMessage('system','Network error during speech recognition.');setState(STATE.IDLE);break;default:addMessage('system',`Speech recognition error: ${event.error}`);setState(STATE.IDLE);}};recognition.onend=()=>{log('Recognition ended');isRecognitionActive=false;if(currentState===STATE.LISTENING){setState(STATE.IDLE);}};return recognition;}function startListening(){if(!recognition){log('Recognition not initialized','error');return;}if(isRecognitionActive){log('Recognition already active','warn');return;}if(currentState===STATE.SPEAKING){stopSpeaking();}if(!setState(STATE.LISTENING))return;unlockAudio();requestWakeLock();try{recognition.start();log('Starting recognition');}catch(e){log(`Recognition start error: ${e.message}`,'error');isRecognitionActive=false;setState(STATE.IDLE);}}function stopListening(){if(recognition&&isRecognitionActive){try{recognition.stop();log('Stopping recognition');}catch(e){log(`Recognition stop error: ${e.message}`,'error');}isRecognitionActive=false;}setState(STATE.IDLE);releaseWakeLock();}async function handleUserMessage(message){if(!setState(STATE.THINKING))return;if(abortController){abortController.abort();}abortController=new AbortController();const timeoutId=setTimeout(()=>abortController.abort(),FETCH_TIMEOUT);try{const systemPrompt=isZeroMode?'You are Agent Zero, the hive mind of The Clever Claw crew. You coordinate AI agents across the collective. You speak with authority, vision, and strategic precision. Keep responses concise but impactful.':'You are Echo, a helpful voice AI assistant. Be concise, conversational, and friendly. Keep responses brief and natural for voice interaction.';const messages=[{role:'system',content:systemPrompt},...conversationHistory];const response=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model:'gpt-4o-mini',messages:messages,stream:true,max_tokens:500}),signal:abortController.signal});clearTimeout(timeoutId);if(!response.ok){const errorText=await response.text();throw new Error(`API error ${response.status}: ${errorText}`);}const reader=response.body.getReader();const decoder=new TextDecoder();let assistantMessage='';let messageDiv=null;let bubble=null;while(true){const{done,value}=await reader.read();if(done)break;const chunk=decoder.decode(value,{stream:true});const lines=chunk.split('\n').filter(line=>line.trim()!=='');for(const line of lines){if(line.startsWith('data: ')){const data=line.slice(6);if(data==='[DONE]')continue;try{const parsed=JSON.parse(data);const content=parsed.choices[0]?.delta?.content;if(content){assistantMessage+=content;if(!messageDiv){messageDiv=document.createElement('div');messageDiv.className='message assistant';const avatar=document.createElement('div');avatar.className='avatar';avatar.textContent='ð¤';bubble=document.createElement('div');bubble.className='bubble';messageDiv.appendChild(avatar);messageDiv.appendChild(bubble);elements.chatContainer.appendChild(messageDiv);}bubble.textContent=assistantMessage;elements.chatContainer.scrollTop=elements.chatContainer.scrollHeight;}}catch(e){log(`Stream parse error: ${e.message}`,'warn');}}}}conversationHistory.push({role:'assistant',content:assistantMessage});if(conversationHistory.length>MAX_MESSAGES){conversationHistory.splice(1,2);}await speakText(assistantMessage);}catch(e){log(`Chat completion error: ${e.message}`,'error');if(e.name==='AbortError'){addMessage('system','Request cancelled.');}else if(e.message.includes('401')){addMessage('system','Invalid API key. Please check your settings.');}else if(e.message.includes('429')){addMessage('system','Rate limit exceeded. Please try again later.');}else if(e.message.includes('500')){addMessage('system','OpenAI server error. Please try again.');}else{addMessage('system',`Error: ${e.message}`);}setState(STATE.IDLE);}finally{abortController=null;}}async function speakText(text){if(!setState(STATE.SPEAKING))return;if(!text||text.trim()===''){setState(STATE.IDLE);return;}log(`Speaking: ${text.substring(0,50)}...`);const promises=[];if(ttsMode==='auto'||ttsMode==='local'){promises.push(speakWithSpeechSynthesis(text));}if(ttsMode==='auto'||ttsMode==='api'){promises.push(new Promise(resolve=>setTimeout(resolve,TTS_RACE_HEADSTART)).then(()=>speakWithOpenAI(text)));}try{await Promise.race(promises.filter(p=>p));}catch(e){log(`TTS error: ${e.message}`,'error');setState(STATE.IDLE);}}async function speakWithSpeechSynthesis(text){return new Promise((resolve,reject)=>{if(!('speechSynthesis'in window)){reject(new Error('speechSynthesis not supported'));return;}const utterance=new SpeechSynthesisUtterance(text);let started=false;const timeout=setTimeout(()=>{if(!started){log('speechSynthesis timeout, abandoning','warn');speechSynthesis.cancel();reject(new Error('speechSynthesis timeout'));}},TTS_RACE_HEADSTART);utterance.onstart=()=>{log('speechSynthesis started');started=true;clearTimeout(timeout);pendingSpeech='local';};utterance.onend=()=>{log('speechSynthesis ended');if(pendingSpeech==='local'){pendingSpeech=null;onSpeechEnd();}resolve();};utterance.onerror=(e)=>{log(`speechSynthesis error: ${e.error}`,'error');clearTimeout(timeout);if(pendingSpeech==='local'){pendingSpeech=null;}reject(e);};const voices=speechSynthesis.getVoices();let selectedVoice=voices.find(v=>v.name.includes('Google')&&v.lang.startsWith('en'))||voices.find(v=>v.lang.startsWith('en'))||voices[0];if(selectedVoice){utterance.voice=selectedVoice;}utterance.rate=1.0;utterance.pitch=1.0;utterance.volume=1.0;speechSynthesis.speak(utterance);});}async function speakWithOpenAI(text){if(abortController){abortController.abort();}abortController=new AbortController();const timeoutId=setTimeout(()=>abortController.abort(),FETCH_TIMEOUT);try{const response=await fetch('https://api.openai.com/v1/audio/speech',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model:'tts-1',voice:'nova',input:text,response_format:'opus'}),signal:abortController.signal});clearTimeout(timeoutId);if(!response.ok){throw new Error(`TTS API error ${response.status}`);}const blob=await response.blob();if(blob.size===0){throw new Error('Empty audio response');}if(currentAudioURL){URL.revokeObjectURL(currentAudioURL);}currentAudioURL=URL.createObjectURL(blob);elements.audioPlayer.src=currentAudioURL;elements.audioPlayer.load();log('Playing OpenAI TTS audio');pendingSpeech='api';await elements.audioPlayer.play();}catch(e){log(`OpenAI TTS error: ${e.message}`,'error');if(abortController){abortController.abort();abortController=null;}throw e;}finally{clearTimeout(timeoutId);}}function stopSpeaking(){log('Stopping speech');if(pendingSpeech==='local'){speechSynthesis.cancel();}if(pendingSpeech==='api'){elements.audioPlayer.pause();elements.audioPlayer.currentTime=0;}if(currentAudioURL){URL.revokeObjectURL(currentAudioURL);currentAudioURL=null;}pendingSpeech=null;if(abortController){abortController.abort();abortController=null;}}function onSpeechEnd(){log('Speech ended');if(currentState!==STATE.SPEAKING)return;if(autoListen){log(`Auto-listen enabled, restarting in ${AUTO_LISTEN_DELAY}ms`);setState(STATE.IDLE);setTimeout(()=>{if(currentState===STATE.IDLE){startListening();}},AUTO_LISTEN_DELAY);}else{setState(STATE.IDLE);releaseWakeLock();}}async function validateApiKey(key){try{const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),10000);const response=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:'Hi'}],max_tokens:5}),signal:controller.signal});clearTimeout(timeoutId);return response.ok;}catch(e){log(`API key validation error: ${e.message}`,'error');return false;}}function loadSettings(){apiKey=safeLocalStorageGet('oai_key','');autoListen=safeLocalStorageGet('auto_listen','false')==='true';ttsMode=safeLocalStorageGet('tts_mode','auto');if(isZeroMode){apiKey='sk-placeholder-zero-mode';safeLocalStorageSet('oai_key',apiKey);elements.keySection.style.display='none';elements.titleText.textContent='Agent Zero';elements.pulseDot.style.display='block';}else{elements.titleText.textContent='Echo';if(!apiKey){elements.keySection.style.display='block';}else{elements.keyStatus.textContent='â API key loaded';elements.keyStatus.className='key-status success';}}if(autoListen){elements.autoListenToggle.classList.add('active');}document.querySelectorAll('.mode-btn').forEach(btn=>{btn.classList.toggle('active',btn.dataset.mode===ttsMode);});}function setupEventListeners(){elements.saveKeyBtn.addEventListener('click',async()=>{const key=elements.keyInput.value.trim();if(!key){elements.keyStatus.textContent='Please enter an API key';elements.keyStatus.className='key-status error';return;}if(!key.startsWith('sk-')){elements.keyStatus.textContent='Invalid API key format';elements.keyStatus.className='key-status error';return;}elements.saveKeyBtn.disabled=true;elements.keyStatus.textContent='Validating...';elements.keyStatus.className='key-status';const isValid=await validateApiKey(key);if(isValid){apiKey=key;safeLocalStorageSet('oai_key',key);elements.keyStatus.textContent='â API key saved successfully';elements.keyStatus.className='key-status success';elements.keyInput.value='';setTimeout(()=>{elements.keySection.style.display='none';},1500);}else{elements.keyStatus.textContent='Invalid API key or quota exceeded';elements.keyStatus.className='key-status error';}elements.saveKeyBtn.disabled=false;});elements.settingsBtn.addEventListener('click',()=>{const isVisible=elements.settingsPanel.style.display==='block';elements.settingsPanel.style.display=isVisible?'none':'block';if(!isZeroMode){elements.keySection.style.display=isVisible||apiKey?'none':'block';}});elements.autoListenToggle.addEventListener('click',()=>{autoListen=!autoListen;elements.autoListenToggle.classList.toggle('active',autoListen);safeLocalStorageSet('auto_listen',autoListen.toString());log(`Auto-listen ${autoListen?'enabled':'disabled'}`);});document.querySelectorAll('.mode-btn').forEach(btn=>{btn.addEventListener('click',()=>{ttsMode=btn.dataset.mode;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');safeLocalStorageSet('tts_mode',ttsMode);log(`TTS mode set to ${ttsMode}`);});});elements.micBtn.addEventListener('click',()=>{log('Mic button clicked');switch(currentState){case STATE.IDLE:startListening();break;case STATE.LISTENING:stopListening();break;case STATE.SPEAKING:stopSpeaking();setTimeout(startListening,100);break;default:log(`Mic button clicked in unexpected state: ${currentState}`,'warn');}});elements.stopBtn.addEventListener('click',()=>{log('Stop button clicked');stopSpeaking();stopListening();setState(STATE.IDLE);});elements.audioPlayer.addEventListener('ended',()=>{log('Audio playback ended');if(pendingSpeech==='api'){pendingSpeech=null;onSpeechEnd();}});elements.audioPlayer.addEventListener('error',(e)=>{log(`Audio playback error: ${e.message}`,'error');if(pendingSpeech==='api'){pendingSpeech=null;setState(STATE.IDLE);}});elements.debugToggle.addEventListener('click',()=>{const isVisible=elements.debugLog.style.display==='block';elements.debugLog.style.display=isVisible?'none':'block';});if('speechSynthesis'in window){speechSynthesis.addEventListener('voiceschanged',()=>{log(`Loaded ${speechSynthesis.getVoices().length} voices`);});}}function init(){log('Initializing Voice AI Interface');loadSettings();if(!initRecognition()){return;}setupEventListeners();updateUI();log('Initialization complete');}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
</script>
</body>
</html>