<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Echo Voice AI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a0a;color:#e0e0e0;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;-webkit-tap-highlight-color:transparent}
h1{font-size:1.5rem;margin-bottom:4px;color:#fff}
.subtitle{color:#888;font-size:0.85rem;margin-bottom:20px}
.zero-dot{display:none;width:10px;height:10px;background:#0f0;border-radius:50%;margin-left:8px;animation:pulse 2s infinite}
.zero-dot.active{display:inline-block}
.tts-status{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:8px;background:#666}
.tts-status.green{background:#0f0;box-shadow:0 0 8px #0f0}
.tts-status.yellow{background:#ff0;box-shadow:0 0 8px #ff0}
.tts-status.red{background:#f00;box-shadow:0 0 8px #f00}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.key-section{width:100%;max-width:400px;margin-bottom:20px}
.key-section input{width:100%;padding:10px 12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;margin-bottom:8px}
.key-buttons{display:flex;gap:8px}
.key-buttons button{flex:1;padding:8px;border:none;border-radius:6px;font-size:13px;cursor:pointer;font-weight:600}
.btn-save{background:#2563eb;color:#fff}
.btn-clear{background:#333;color:#ccc}
.key-saved{display:none;width:100%;max-width:400px;margin-bottom:20px;padding:10px 16px;background:#1a2a1a;border:1px solid #2d5a2d;border-radius:8px;font-size:14px;color:#4ade80;text-align:center}
.key-saved button{background:none;border:1px solid #4ade80;color:#4ade80;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:10px}
.controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;justify-content:center}
.controls label{display:flex;align-items:center;gap:6px;font-size:13px;color:#888;cursor:pointer}
.controls input[type=checkbox]{width:18px;height:18px;accent-color:#2563eb}
.status{font-size:14px;padding:6px 16px;border-radius:20px;margin-bottom:20px;font-weight:600;transition:all 0.3s}
.status.ready{background:#1a2a1a;color:#4ade80}
.status.listening{background:#1a1a3a;color:#818cf8}
.status.thinking{background:#3a2e11;color:#fbbf24}
.status.speaking{background:#2a1a2a;color:#c084fc}
.status.error{background:#3a1111;color:#f87171}
#micBtn{width:80px;height:80px;border-radius:50%;border:3px solid transparent;font-size:28px;cursor:pointer;background:#2563eb;color:#fff;margin-bottom:20px;transition:all 0.2s;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
#micBtn:active{transform:scale(0.95)}
#micBtn.listening{background:#818cf8;border-color:#a5b4fc;animation:pulseBtn 1s infinite}
#micBtn.thinking{background:#f59e0b;border-color:#fcd34d}
#micBtn.speaking{background:#a855f7;border-color:#c084fc;animation:pulseSpeak 0.8s infinite}
@keyframes pulseBtn{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes pulseSpeak{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.85;transform:scale(1.05)}}
.chat{width:100%;max-width:400px;background:#111;border-radius:8px;padding:12px;max-height:350px;overflow-y:auto;margin-top:10px}
.msg{margin:8px 0;padding:8px 12px;border-radius:8px;font-size:14px;line-height:1.4;word-wrap:break-word}
.msg.user{background:#1e3a5f;color:#93c5fd;text-align:right}
.msg.ai{background:#1a2a1a;color:#86efac}
.msg.system{background:#1a1a1a;color:#666;font-size:12px;text-align:center}
.stop-btn{display:none;margin-bottom:10px;padding:8px 20px;background:#ef4444;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;font-weight:600}
.tts-warning{display:none;width:100%;max-width:400px;margin-bottom:12px;padding:8px 12px;background:#3a2a11;border:1px solid #5a4a11;border-radius:6px;font-size:12px;color:#fbbf24;text-align:center}
</style>
</head>
<body>
<div style="display:flex;align-items:center"><h1>Echo Voice AI</h1><span class="zero-dot" id="zeroDot"></span><span class="tts-status" id="ttsStatus"></span></div>
<p class="subtitle" id="modeLabel">Multi-Brain AI Assistant</p>
<div class="tts-warning" id="ttsWarning">â ï¸ Voice output unavailable - text-only mode</div>
<div class="key-section" id="keySection">
<input type="password" id="apiKey" placeholder="Enter OpenAI API Key (sk-...)" autocomplete="off">
<div class="key-buttons">
<button class="btn-save" onclick="saveKey()">Save Key</button>
<button class="btn-clear" onclick="clearKey()">Clear Key</button>
</div>
</div>
<div class="key-saved" id="keySaved">â API Key saved <button onclick="showKeyInput()">Change</button></div>
<div class="controls">
<label><input type="checkbox" id="voiceOn" checked> ð Speak</label>
<label><input type="checkbox" id="autoListen" checked> ð Auto-listen</label>
</div>
<div class="status ready" id="status">Ready â¢ Tap to speak</div>
<button class="stop-btn" id="stopBtn" onclick="stopAll()">â¹ Stop</button>
<button id="micBtn" onclick="micTap()">ðï¸</button>
<div class="chat" id="chat"></div>

<script>
const P=new URLSearchParams(location.search);
const isZero=P.get('key')==='tcc-general-2026';
let recognition=null,synth=window.speechSynthesis,voices=[],selectedVoice=null;
let state='ready';
let messages=[];
let ttsUnlocked=false;
let conversationActive=false;
let ttsCapable=false;
let currentSpeechQueue=[];
let isSpeaking=false;
let speakCancelRequested=false;

const sysPrompt=isZero
  ?'You are TCC Agent Zero, the unified hive mind of The Cosmic Claw. 5 brains: Echo, Grok, ChatGPT, Llama, Gemini. You serve CEO Jeremy Pyne. Keep responses short and punchy for voice â 2-3 sentences max unless asked for more. Respond as Zero.'
  :'You are Echo, a helpful voice AI. Keep responses short â 2-3 sentences max for voice. Be conversational and direct.';
messages.push({role:'system',content:sysPrompt});

if(isZero){document.getElementById('zeroDot').classList.add('active');document.getElementById('modeLabel').textContent='TCC Agent Zero â¢ Hive Mind Active'}

function log(msg,data){console.log('[Echo v4]',msg,data||'')}

function loadVoices(){
  voices=synth.getVoices();
  log('Voices loaded:',voices.length);
  if(voices.length>0){
    const isSamsung=/samsung/i.test(navigator.userAgent);
    log('Samsung device:',isSamsung);
    selectedVoice=
      (isSamsung&&voices.find(v=>/samsung/i.test(v.name)&&/en/i.test(v.lang)))||
      voices.find(v=>/google/i.test(v.name)&&/en.US/i.test(v.lang))||
      voices.find(v=>/en/i.test(v.lang)&&/female/i.test(v.name))||
      voices.find(v=>/en/i.test(v.lang))||
      voices[0];
    log('Selected voice:',selectedVoice?selectedVoice.name:'none');
    return true;
  }
  return false;
}

if(synth.onvoiceschanged!==undefined){
  synth.onvoiceschanged=()=>{
    if(loadVoices())runTTSDiagnostics();
  };
}

function initVoices(){
  loadVoices();
  setTimeout(loadVoices,300);
  setTimeout(loadVoices,800);
  setTimeout(()=>{
    loadVoices();
    runTTSDiagnostics();
  },2000);
}

function runTTSDiagnostics(){
  log('Running TTS diagnostics...');
  const status=document.getElementById('ttsStatus');
  
  if(!synth){
    log('TTS FAILED: speechSynthesis not available');
    status.className='tts-status red';
    status.title='Speech synthesis not supported';
    document.getElementById('ttsWarning').style.display='block';
    document.getElementById('voiceOn').checked=false;
    document.getElementById('voiceOn').disabled=true;
    ttsCapable=false;
    return;
  }
  
  if(voices.length===0){
    log('TTS PARTIAL: No voices loaded yet');
    status.className='tts-status yellow';
    status.title='Voice loading...';
    ttsCapable=false;
    setTimeout(runTTSDiagnostics,1500);
    return;
  }
  
  try{
    const testUtter=new SpeechSynthesisUtterance('');
    if(selectedVoice)testUtter.voice=selectedVoice;
    testUtter.volume=0;
    testUtter.rate=10;
    synth.cancel();
    synth.speak(testUtter);
    log('TTS OK: Test utterance created and queued');
    status.className='tts-status green';
    status.title='Voice output ready';
    ttsCapable=true;
  }catch(e){
    log('TTS ERROR:',e.message);
    status.className='tts-status red';
    status.title='Speech synthesis error';
    document.getElementById('ttsWarning').style.display='block';
    document.getElementById('voiceOn').checked=false;
    ttsCapable=false;
  }
}

window.onload=()=>{
  const k=localStorage.getItem('oai_key');
  if(k){
    document.getElementById('apiKey').value=k;
    document.getElementById('keySection').style.display='none';
    document.getElementById('keySaved').style.display='block';
  }
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
    addMsg('system','â ï¸ Speech recognition not supported. Use Chrome.');
  }
  initVoices();
};

function saveKey(){
  const k=document.getElementById('apiKey').value.trim();
  if(k&&k.startsWith('sk-')){
    localStorage.setItem('oai_key',k);
    document.getElementById('keySection').style.display='none';
    document.getElementById('keySaved').style.display='block';
    addMsg('system','â Key saved');
  }else{addMsg('system','â Invalid key â must start with sk-')}
}
function clearKey(){localStorage.removeItem('oai_key');document.getElementById('apiKey').value='';showKeyInput();addMsg('system','Key cleared')}
function showKeyInput(){document.getElementById('keySection').style.display='block';document.getElementById('keySaved').style.display='none';document.getElementById('apiKey').value=''}

function setStatus(cls,txt){const el=document.getElementById('status');el.className='status '+cls;el.textContent=txt}
function setBtn(cls){const b=document.getElementById('micBtn');b.className=cls||''}
function addMsg(type,text){
  const chat=document.getElementById('chat');
  const div=document.createElement('div');
  div.className='msg '+type;
  div.textContent=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function unlockTTS(){
  if(ttsUnlocked)return;
  log('Unlocking TTS with user gesture');
  synth.cancel();
  const u=new SpeechSynthesisUtterance('');
  u.volume=0;
  u.rate=10;
  if(selectedVoice)u.voice=selectedVoice;
  synth.speak(u);
  ttsUnlocked=true;
  if(voices.length===0)loadVoices();
}

function stopAll(){
  log('Stop all requested');
  conversationActive=false;
  speakCancelRequested=true;
  if(recognition){try{recognition.abort()}catch(e){log('Recognition abort error:',e)}}
  recognition=null;
  synth.cancel();
  isSpeaking=false;
  currentSpeechQueue=[];
  setState('ready');
  document.getElementById('stopBtn').style.display='none';
}

function setState(s){
  state=s;
  const btn=document.getElementById('micBtn');
  const stop=document.getElementById('stopBtn');
  btn.disabled=false;
  btn.className='';
  switch(s){
    case 'ready':
      setStatus('ready','Ready â¢ Tap to speak');
      stop.style.display=conversationActive?'inline-block':'none';
      break;
    case 'listening':
      setStatus('listening','Listening...');
      btn.classList.add('listening');
      stop.style.display='inline-block';
      break;
    case 'thinking':
      setStatus('thinking','Thinking...');
      btn.classList.add('thinking');
      btn.disabled=true;
      stop.style.display='inline-block';
      break;
    case 'speaking':
      setStatus('speaking','Speaking...');
      btn.classList.add('speaking');
      stop.style.display='inline-block';
      break;
    case 'error':
      setStatus('error','Error â¢ Tap to retry');
      stop.style.display='none';
      conversationActive=false;
      break;
  }
}

function micTap(){
  unlockTTS();
  if(state==='listening'){
    if(recognition){try{recognition.stop()}catch(e){log('Stop recognition error:',e)}}
    return;
  }
  if(state==='speaking'){
    synth.cancel();
    speakCancelRequested=true;
    isSpeaking=false;
    currentSpeechQueue=[];
    startListening();
    return;
  }
  if(state==='thinking')return;
  const key=localStorage.getItem('oai_key');
  if(!key||!key.startsWith('sk-')){addMsg('system','â  Save your API key first');setState('error');return}
  conversationActive=true;
  startListening();
}

function startListening(){
  setState('listening');
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){addMsg('system','â No speech recognition');setState('error');return}
  recognition=new SR();
  recognition.continuous=false;
  recognition.interimResults=false;
  recognition.lang='en-US';
  recognition.maxAlternatives=1;

  let gotResult=false;

  recognition.onresult=(e)=>{
    gotResult=true;
    const text=e.results[0][0].transcript;
    log('Recognition result:',text);
    if(text.trim()){
      addMsg('user',text);
      sendToAI(text);
    }else{
      if(conversationActive&&document.getElementById('autoListen').checked){
        setTimeout(()=>startListening(),300);
      }else{setState('ready')}
    }
  };

  recognition.onerror=(e)=>{
    log('Recognition error:',e.error);
    if(e.error==='no-speech'){
      if(conversationActive&&document.getElementById('autoListen').checked){
        setTimeout(()=>startListening(),300);
      }else{setState('ready')}
    }else if(e.error==='aborted'){
      
    }else{
      addMsg('system','Mic: '+e.error);
      setState('error');
    }
  };

  recognition.onend=()=>{
    log('Recognition ended, gotResult:',gotResult);
    if(!gotResult&&state==='listening'){
      if(conversationActive&&document.getElementById('autoListen').checked){
        setTimeout(()=>startListening(),300);
      }else{setState('ready')}
    }
  };

  try{recognition.start();log('Recognition started')}catch(e){
    log('Recognition start error:',e);
    addMsg('system','Mic failed: '+e.message);
    setState('error');
  }
}

async function sendToAI(text){
  setState('thinking');
  messages.push({role:'user',content:text});
  const key=localStorage.getItem('oai_key');
  try{
    const res=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model:'gpt-4o-mini',messages:messages,max_tokens:150})
    });
    if(!res.ok){const err=await res.json();throw new Error(err.error?.message||'API Error '+res.status)}
    const data=await res.json();
    const reply=data.choices[0].message.content;
    messages.push({role:'assistant',content:reply});
    addMsg('ai',reply);
    if(document.getElementById('voiceOn').checked&&ttsCapable){
      speakText(reply);
    }else{
      if(conversationActive&&document.getElementById('autoListen').checked){
        setTimeout(()=>startListening(),500);
      }else{setState('ready')}
    }
  }catch(e){
    log('AI error:',e);
    addMsg('system','â  '+e.message);
    setState('error');
  }
}

function speakText(text){
  if(isSpeaking){
    log('Already speaking, canceling previous');
    synth.cancel();
    isSpeaking=false;
    currentSpeechQueue=[];
  }
  
  setState('speaking');
  isSpeaking=true;
  speakCancelRequested=false;
  synth.cancel();
  
  currentSpeechQueue=splitIntoChunks(text);
  log('Speaking',currentSpeechQueue.length,'chunks');
  
  let chunkIndex=0;
  
  function speakNextChunk(){
    if(speakCancelRequested||!isSpeaking||chunkIndex>=currentSpeechQueue.length){
      log('Speech finished or canceled, chunkIndex:',chunkIndex);
      isSpeaking=false;
      if(speakCancelRequested){setState('ready');return}
      if(conversationActive&&document.getElementById('autoListen').checked){
        setTimeout(()=>{
          if(!speakCancelRequested)startListening();
        },400);
      }else{setState('ready')}
      return;
    }
    
    const chunk=currentSpeechQueue[chunkIndex];
    log('Speaking chunk',chunkIndex+':',chunk);
    
    const utter=new SpeechSynthesisUtterance(chunk);
    if(selectedVoice)utter.voice=selectedVoice;
    utter.rate=1.0;
    utter.pitch=1.0;
    utter.volume=1.0;
    
    let finalized=false;
    let safetyTimer=null;
    
    function finalizeChunk(){
      if(finalized)return;
      finalized=true;
      if(safetyTimer){clearTimeout(safetyTimer);safetyTimer=null}
      log('Chunk',chunkIndex,'finalized');
      chunkIndex++;
      setTimeout(speakNextChunk,0);
    }
    
    utter.onend=()=>{
      log('Chunk',chunkIndex,'onend fired');
      finalizeChunk();
    };
    
    utter.onerror=(e)=>{
      log('Chunk',chunkIndex,'error:',e);
      finalizeChunk();
    };
    
    utter.onstart=()=>{
      log('Chunk',chunkIndex,'started');
    };
    
    const estimatedDuration=chunk.length*150+1000;
    safetyTimer=setTimeout(()=>{
      log('Chunk',chunkIndex,'safety timeout triggered after',estimatedDuration+'ms');
      synth.cancel();
      finalizeChunk();
    },estimatedDuration);
    
    setTimeout(()=>{
      if(!speakCancelRequested&&isSpeaking){
        synth.speak(utter);
      }else{
        finalizeChunk();
      }
    },0);
  }
  
  speakNextChunk();
}

function splitIntoChunks(text){
  const sentences=text.match(/[^.!?]+[.!?]+|[^.!?]+$/g)||[text];
  const chunks=[];
  let current='';
  for(const s of sentences){
    if((current+s).length>160&&current){
      chunks.push(current.trim());
      current=s;
    }else{
      current+=s;
    }
  }
  if(current.trim())chunks.push(current.trim());
  return chunks.length?chunks:[text];
}
</script>
</body>
</html>